name: Mango Pro Multi-Platform

on:
  workflow_dispatch:
    inputs:
      app_name:
        required: true
      package_name:
        required: true
      web_url:
        default: 'none'
      splash_time:
        default: '3000'

jobs:
  # --- ANDROID JOB (APK & AAB) ---
  android-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android Project
        run: |
          # Agar gradlew missing hai to naya banao
          if [ ! -f "gradlew" ]; then
            gradle wrapper
          fi
          chmod +x gradlew

          # Dashboard Assets Sync
          mkdir -p app/src/main/assets
          [ -f "index.html" ] && cp index.html app/src/main/assets/index.html
          
          # Android Manifest aur Package Name update (Deep Search)
          find . -name "AndroidManifest.xml" -exec sed -i 's/android:label="[^"]*"/android:label="${{ github.event.inputs.app_name }}"/g' {} +
          find . -name "build.gradle" -exec sed -i "s/applicationId \"[^\"]*\"/applicationId \"${{ github.event.inputs.package_name }}\"/g" {} +

      - name: Build Android Release
        run: |
          # Force build even if there are minor errors
          ./gradlew assembleRelease --no-daemon || echo "APK Build failed, checking reasons..."
          ./gradlew bundleRelease --no-daemon || echo "AAB Build failed..."

      - name: Collect Android Artifacts
        run: |
          mkdir -p android_builds
          # Poori repository mein se APK aur AAB dhoond kar copy karo
          find . -name "*.apk" -exec cp {} android_builds/ \;
          find . -name "*.aab" -exec cp {} android_builds/ \;
          # Check if files exist
          ls -R android_builds/

      - name: Upload Android Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_name }}-Android-Files
          path: android_builds/
          if-no-files-found: error

  # --- iOS JOB (IPA / Zip) ---
  ios-build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare iOS Files
        run: |
          mkdir -p ios_output
          # Dashboard info save karein
          echo "App Name: ${{ github.event.inputs.app_name }}" > ios_output/info.txt
          echo "Package: ${{ github.event.inputs.package_name }}" >> ios_output/info.txt
          # Pura project zip karein (Standard for iOS manual signing)
          zip -r ios_output/${{ github.event.inputs.app_name }}_iOS.zip . -x "android/*" "node_modules/*"

      - name: Upload iOS Result
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_name }}-iOS-Project
          path: ios_output/
