name: Mango Ultimate Build
on:
  workflow_dispatch:
    inputs:
      app_name:
        required: true
        type: string
      package_name:
        required: true
        type: string
      web_url:
        required: false
        type: string
        default: 'none'
      splash_time:
        required: false
        type: string
        default: '3000'
      html_content:
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Process Dashboard Inputs
        run: |
          echo "ðŸ“± Building App: ${{ github.event.inputs.app_name }}"
          echo "ðŸ“¦ Package: ${{ github.event.inputs.package_name }}"
          echo "ðŸŒ Web URL: ${{ github.event.inputs.web_url }}"
          echo "â±ï¸ Splash Time: ${{ github.event.inputs.splash_time }}ms"
          
          # Create or update index.html with dashboard content
          if [ "${{ github.event.inputs.html_content }}" != "" ]; then
            echo "ðŸ“ Using custom HTML from dashboard"
            echo "${{ github.event.inputs.html_content }}" > index.html
          fi
          
          # Update app name in strings.xml
          mkdir -p app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">'"${{ github.event.inputs.app_name }}"'</string>
</resources>' > app/src/main/res/values/strings.xml
          
          # Update package name in AndroidManifest.xml
          sed -i "s/package=\"[^\"]*\"/package=\"${{ github.event.inputs.package_name }}\"/g" app/src/main/AndroidManifest.xml 2>/dev/null || true
          
          echo "âœ… App configuration updated"

      - name: Build Debug APK
        run: |
          echo "ðŸ”¨ Building Debug APK..."
          ./gradlew clean
          ./gradlew assembleDebug
          echo "âœ… Debug APK built successfully"

      - name: Build Release APK
        run: |
          echo "ðŸ”¨ Building Release APK..."
          # Create a simple keystore for signing (for testing)
          keytool -genkeypair \
            -v -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug, O=Android, C=US"
            
          ./gradlew assembleRelease
          echo "âœ… Release APK built successfully"

      - name: Build Android App Bundle (AAB)
        run: |
          echo "ðŸ“¦ Building Android App Bundle..."
          ./gradlew bundleRelease
          echo "âœ… AAB file built successfully"

      - name: List Generated Files
        run: |
          echo "ðŸ“ Generated Files:"
          find . -name "*.apk" -type f 2>/dev/null | while read file; do
            echo "  ðŸ“„ $file"
          done
          
          find . -name "*.aab" -type f 2>/dev/null | while read file; do
            echo "  ðŸ“¦ $file"
          done
          
          echo ""
          echo "ðŸ“Š Build Summary:"
          echo "  App: ${{ github.event.inputs.app_name }}"
          echo "  Package: ${{ github.event.inputs.package_name }}"
          if [ "${{ github.event.inputs.web_url }}" != "none" ]; then
            echo "  URL: ${{ github.event.inputs.web_url }}"
          fi

      - name: Upload APK Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_name }}-APK-Files
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          if-no-files-found: warn

      - name: Create Build Report
        run: |
          mkdir -p build-report
          cat > build-report/README.md << EOF
# ðŸ¥­ Mango Build Report

## App Information
- **App Name:** ${{ github.event.inputs.app_name }}
- **Package Name:** ${{ github.event.inputs.package_name }}
- **Build Time:** $(date)
- **Build ID:** ${{ github.run_id }}

## Generated Files
1. **app-debug.apk** - For testing (no signing required)
2. **app-release.apk** - Signed APK for direct installation
3. **app-release.aab** - Android App Bundle for Play Store

## Installation Guide
### Debug APK
- Enable "Unknown Sources" in Android settings
- Install directly on any device

### Release APK
- Ready for distribution
- Can be uploaded to app stores

### AAB File
- Upload to Google Play Console
- Better optimization for Play Store

## Next Steps
1. Download APK files from Artifacts section
2. Test on Android device
3. Share with users or upload to store

---
*Generated by Mango Builder*
EOF
          
          echo "ðŸ“‹ Build report created"

      - name: Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: Build-Report
          path: build-report/
