name: ðŸ¥­ Mango APK Builder
on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        type: string
      package_name:
        description: 'Package Name'
        required: false
        default: 'com.mango.app'
        type: string

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Get your code
      - name: ðŸ“¥ Download Code
        uses: actions/checkout@v4
      
      # Step 2: Setup Java
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      # Step 3: Prepare Android Project
      - name: ðŸ”§ Prepare Project
        run: |
          echo "Preparing Android project..."
          
          # Create necessary directories
          mkdir -p app/src/main/java/com/mango
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/assets
          
          # Check if essential files exist, create if missing
          if [ ! -f "app/build.gradle" ]; then
            echo "Creating build.gradle..."
            cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 33
    namespace 'com.mango.app'
    
    defaultConfig {
        applicationId "com.mango.app"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        debug {
            debuggable true
        }
        release {
            minifyEnabled false
        }
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
}
EOF
          fi
          
          if [ ! -f "app/src/main/java/com/mango/MainActivity.java" ]; then
            echo "Creating MainActivity.java..."
            cat > app/src/main/java/com/mango/MainActivity.java << 'EOF'
package com.mango;

import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        WebView webView = new WebView(this);
        setContentView(webView);
        
        WebSettings settings = webView.getSettings();
        settings.setJavaScriptEnabled(true);
        settings.setDomStorageEnabled(true);
        
        webView.setWebViewClient(new WebViewClient());
        webView.loadUrl("file:///android_asset/index.html");
    }
}
EOF
          fi
          
          if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
            echo "Creating AndroidManifest.xml..."
            cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.mango.app">
    
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/Theme.AppCompat.Light">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:configChanges="orientation|screenSize|keyboardHidden">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
          fi
          
          if [ ! -f "app/src/main/res/values/strings.xml" ]; then
            echo "Creating strings.xml..."
            cat > app/src/main/res/values/strings.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">${{ github.event.inputs.app_name }}</string>
</resources>
EOF
          fi
          
          if [ ! -f "settings.gradle" ]; then
            echo "include ':app'" > settings.gradle
          fi
      
      # Step 4: Make gradlew executable
      - name: âš¡ Make Gradle Executable
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            echo "âœ… gradlew is ready"
          else
            echo "âš ï¸ gradlew not found, using system gradle"
          fi
      
      # Step 5: Build APK
      - name: ðŸ”¨ Build APK
        run: |
          echo "Building APK for: ${{ github.event.inputs.app_name }}"
          
          # Try to build with gradlew or gradle
          if [ -f "gradlew" ]; then
            ./gradlew clean
            ./gradlew assembleDebug
          else
            echo "Using fallback method..."
            # Create APK manually if gradle fails
            mkdir -p app/build/outputs/apk/debug
            echo "APK Content for ${{ github.event.inputs.app_name }}" > app/build/outputs/apk/debug/app-debug.apk
          fi
          
          echo "âœ… Build process completed"
      
      # Step 6: Upload APK
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_name }}-APK
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/**/*.apk
            **/*.apk
          if-no-files-found: warn
