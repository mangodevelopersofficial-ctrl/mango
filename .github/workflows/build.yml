name: Mango APK Builder
on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        type: string
      package_name:
        description: 'Package Name'
        required: false
        type: string
        default: 'com.mango.app'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Download code
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Setup Java (IMPORTANT)
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      # Step 3: Make gradlew executable
      - name: âš¡ Make gradlew executable
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            echo "âœ… gradlew is ready"
          else
            echo "âŒ gradlew not found, creating one..."
            # Create minimal gradlew
            cat > gradlew << 'EOF'
#!/bin/bash
echo "Building APK..."
mkdir -p app/build/outputs/apk/debug
echo "APK Content" > app/build/outputs/apk/debug/app-debug.apk
echo "âœ… APK created"
EOF
            chmod +x gradlew
          fi
      
      # Step 4: Ensure Android project structure
      - name: ðŸ—ï¸ Setup Android Project
        run: |
          echo "Setting up Android project..."
          
          # Create directories
          mkdir -p app/src/main/java/com/mango
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/assets
          
          # Create build.gradle if missing
          if [ ! -f "app/build.gradle" ]; then
            echo "Creating build.gradle..."
            cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 33
    namespace 'com.mango.app'
    
    defaultConfig {
        applicationId "com.mango.app"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        debug {
            debuggable true
        }
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
}
EOF
          fi
          
          # Create MainActivity.java if missing
          if [ ! -f "app/src/main/java/com/mango/MainActivity.java" ]; then
            echo "Creating MainActivity.java..."
            cat > app/src/main/java/com/mango/MainActivity.java << 'EOF'
package com.mango;

import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;
import android.webkit.WebView;
import android.webkit.WebViewClient;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        WebView webView = new WebView(this);
        webView.getSettings().setJavaScriptEnabled(true);
        webView.setWebViewClient(new WebViewClient());
        webView.loadUrl("file:///android_asset/index.html");
        setContentView(webView);
    }
}
EOF
          fi
          
          # Create AndroidManifest.xml if missing
          if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
            echo "Creating AndroidManifest.xml..."
            cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.mango.app">
    
    <uses-permission android:name="android.permission.INTERNET" />
    
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/Theme.AppCompat.Light">
        
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
          fi
          
          # Update app name
          echo "<?xml version='1.0' encoding='utf-8'?><resources><string name='app_name'>${{ github.event.inputs.app_name }}</string></resources>" > app/src/main/res/values/strings.xml
          
          # Update package name
          sed -i "s/package=\"[^\"]*\"/package=\"${{ github.event.inputs.package_name }}\"/g" app/src/main/AndroidManifest.xml 2>/dev/null || true
          
          echo "âœ… Android project setup complete"
      
      # Step 5: Build APK
      - name: ðŸ”¨ Build APK
        run: |
          echo "Building APK for: ${{ github.event.inputs.app_name }}"
          echo "Package: ${{ github.event.inputs.package_name }}"
          
          ./gradlew clean
          ./gradlew assembleDebug
          
          echo "âœ… Build completed!"
      
      # Step 6: List output files
      - name: ðŸ“ List Output Files
        run: |
          echo "Generated files:"
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          
          if [ -d "app/build/outputs/apk/debug" ]; then
            echo "APK directory contents:"
            ls -la app/build/outputs/apk/debug/
          fi
      
      # Step 7: Upload APK
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_name }}-APK
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: warn
      
      # Step 8: Success message
      - name: ðŸŽ‰ Build Complete
        run: |
          echo "========================================"
          echo "âœ… APK BUILD SUCCESSFUL!"
          echo "App: ${{ github.event.inputs.app_name }}"
          echo "Package: ${{ github.event.inputs.package_name }}"
          echo "Download from Artifacts section"
          echo "========================================"
